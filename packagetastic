#!/usr/bin/env python
# -*- coding: UTF-8 -*-

import os, sys
import lib_packagetastic

# Move the path to the location of the current file
os.chdir(os.sys.path[0])

# Determine what we are going to do
mode = ""
if len(sys.argv) >= 4 and sys.argv[1] == "build":
	mode = "build"
elif len(sys.argv) >= 3 and sys.argv[1] == "build_all":
	mode = "build_all"
elif len(sys.argv) == 5 and sys.argv[1] == "gen_stem":
	mode = "gen_stem"
else:
	mode = "help"

# Show the usage
if mode == "help":
	print "usage:"
	print "./packagetastic build distro:=name package:=name"
	print "./packagetastic build_all distro:=name"
	print "./packagetastic gen_stem name:=name version:=version source:=url"
	print ""
	print "build: Generates a native package for the target distro."
	print "build_all: Generates all the native packages for the target distro."
	print "gen_stem: Generates a stem file from the source code at the url."
	print ""
	print "examples:"
	print "./packagetastic build distro:=ubuntu package:=hello"
	print "./packagetastic build_all distro:=fedora"
	print "./packagetastic gen_stem name:=hello version:=2.1.1 source:=http://ftp.gnu.org/gnu/hello/hello-2.1.1.tar.gz"
	exit()

# Build a package
if mode == "build":
	package_name, distro_name = None, None

	# Get the arguments
	for arg in sys.argv[2:]:
		if arg.startswith('package:='):
			package_name = arg.lower().split(':=')[1]
		elif arg.startswith('distro:='):
			distro_name = arg.lower().split(':=')[1]

	# Make sure we got something
	pairs = {'package' : package_name, 'distro' : distro_name}
	for key, value in pairs.iteritems():
		if value == None:
			print "No argument for " + key + " was found. Exiting ..."
			exit()

	# Setup packagetastic
	lib_packagetastic.init_packagetastic(distro_name)

	# Build the package
	lib_packagetastic.build(distro_name, package_name)

# Build all packages
if mode == "build_all":
	distro_name = None

	# Get the arguments
	for arg in sys.argv[2:]:
		if arg.startswith('distro:='):
			distro_name = arg.lower().split(':=')[1]

	# Make sure we got something
	pairs = {'distro' : distro_name}
	for key, value in pairs.iteritems():
		if value == None:
			print "No argument for " + key + " was found. Exiting ..."
			exit()

	# Setup packagetastic
	lib_packagetastic.init_packagetastic(distro_name)

	# Get a list of all the stem files
	stem_names = []
	for entry in os.listdir('stems/'):
		if entry.endswith('.stem') and os.path.isfile('stems/' + entry):
			stem_name = entry.split('.stem')[0]
			stem_names.append(stem_name)
	stem_names.sort()

	# Build all the packages
	for package_name in stem_names:
		try:
			lib_packagetastic.build(distro_name, package_name)
		except KeyboardInterrupt:
			raise
		except:
			pass

# Generate a stem file
if mode == "gen_stem":
	name, version, source = None, None, None

	# Get the arguments
	for arg in sys.argv[2:]:
		if arg.startswith('name:='):
			name = arg.lower().split(':=')[1]
		elif arg.startswith('version:='):
			version = arg.lower().split(':=')[1]
		elif arg.startswith('source:='):
			source = arg.lower().split(':=')[1]

	# Make sure we got something
	pairs = {'name' : name, 'version' : version, 'source' : source}
	for key, value in pairs.iteritems():
		if value == None:
			print "No argument for " + key + " was found. Exiting ..."
			exit()

	lib_packagetastic.gen_stem(name, version, source)



